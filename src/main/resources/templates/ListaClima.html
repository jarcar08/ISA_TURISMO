<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<link rel="icon" type="image/png" href="/img/favicon.ico">
<title>Gestión de Climas</title>
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>

<body>

<div th:replace="~{fragments/header :: navbar}"></div>

<div class="container mt-4">
	<h2 class="mb-4">Lista de Climas</h2>

	<div class="mb-3">
		<label for="searchValor" class="form-label">Buscar por Estado</label>
		<input type="text" class="form-control" id="searchValor"
			placeholder="Escribe un estado...">
	</div>

	<div id="resultadoConteo" class="mb-3 text-muted"></div>

	<button class="btn btn-success mb-3" data-bs-toggle="modal"
		data-bs-target="#climaModal" onclick="abrirModal()">Nuevo
		Clima +</button>

	<table class="table table-bordered table-striped">
		<thead>
			<tr>
				<th>Id</th>
				<th>Estado</th>
				<th>Temp Máx</th>
				<th>Temp Mín</th>
				<th>Recomendación</th>
				<th>Fecha</th>
				<th>Estación</th>
				<th>Operaciones</th>
			</tr>
		</thead>
		<tbody id="tablaClimas">
		</tbody>
	</table>

	<!-- Modal -->
	<div class="modal fade" id="climaModal" tabindex="-1"
		aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<form id="climaForm" th:action="@{/clima/guardar}" method="post">
					<div class="modal-header">
						<h5 class="modal-title" id="modalTitle">Nuevo Clima</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"
							aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<input type="hidden" id="cliId" name="cliId">
						<div class="row">
							<div class="col-md-6 mb-3">
								<label for="cliEstado" class="form-label">Estado</label>
								<input type="text" class="form-control" id="cliEstado"
									name="cliEstado" required>
							</div>
							<div class="col-md-6 mb-3">
								<label for="cliTempMax" class="form-label">Temp Máx</label>
								<input type="number" step="any" class="form-control" id="cliTempMax"
									name="cliTempMax" required>
							</div>
							<div class="col-md-6 mb-3">
								<label for="cliTempMin" class="form-label">Temp Mín</label>
								<input type="number" step="any" class="form-control" id="cliTempMin"
									name="cliTempMin" required>
							</div>
							<div class="col-md-6 mb-3">
								<label for="cliFecha" class="form-label">Fecha</label>
								<input type="date" class="form-control" id="cliFecha"
									name="clifecha" required>
							</div>
							<div class="col-12 mb-3">
								<label for="cliRecomendacion" class="form-label">Recomendación</label>
								<input type="text" class="form-control" id="cliRecomendacion"
									name="cliRecomendacion">
							</div>
							<div class="col-12 mb-3">
								<label for="estacion" class="form-label">Estación</label>
								<select class="form-select" id="estacion" name="estacion">
									<option value="">-- Selecciona una estación --</option>
									<option th:each="est : ${estaciones}" th:value="${est.estId}"
										th:text="${est.estNombre}"></option>
								</select>
							</div>
						</div>
					</div>
					<div class="modal-footer">
						<button type="submit" class="btn btn-primary">Guardar</button>
						<button type="button" class="btn btn-secondary"
							data-bs-dismiss="modal">Cancelar</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
	<script>
function abrirModal() {
	document.getElementById("modalTitle").innerText = "Nuevo Clima";
	document.getElementById("cliId").value = "";
	document.getElementById("cliEstado").value = "";
	document.getElementById("cliTempMax").value = "";
	document.getElementById("cliTempMin").value = "";
	document.getElementById("cliRecomendacion").value = "";
	document.getElementById("cliFecha").value = "";
	document.getElementById("estacion").value = "";
}

function editarClima(id) {
	fetch('/clima/editar/' + id)
	.then(response => response.json())
	.then(data => {
		document.getElementById("modalTitle").innerText = "Editar Clima";
		document.getElementById("cliId").value = data.cliId;
		document.getElementById("cliEstado").value = data.cliEstado;
		document.getElementById("cliTempMax").value = data.cliTempMax;
		document.getElementById("cliTempMin").value = data.cliTempMin;
		document.getElementById("cliRecomendacion").value = data.cliRecomendacion;
		document.getElementById("cliFecha").value = data.clifecha;
		document.getElementById("estacion").value = data.estacion?.estId ?? "";

		const modal = new bootstrap.Modal(document.getElementById("climaModal"));
		modal.show();
	})
	.catch(error => alert("❌ Error al cargar clima: " + error));
}

function eliminarClima(id) {
	if (confirm("¿Estás seguro de eliminar este clima?")) {
		fetch(`/clima/eliminar/${id}`, { method: "DELETE" })
		.then(res => {
			if (res.status === 204) {
				alert("✅ Clima eliminado correctamente.");
				actualizarTabla();
			} else {
				alert("❌ Error al eliminar.");
			}
		});
	}
}

document.getElementById("climaForm").addEventListener("submit", function (event) {
	event.preventDefault();
	const form = event.target;
	const formData = new FormData(form);

	if (!formData.get("cliId")) {
		formData.delete("cliId");
	}

	fetch("/clima/guardar", {
		method: "POST",
		body: formData
	})
	.then(res => res.text())
	.then(data => {
		const modal = bootstrap.Modal.getInstance(document.getElementById("climaModal"));
		modal.hide();
		document.getElementById("searchValor").value = "";
		actualizarTabla();

		if (data === "ok") {
			alert("✅ Clima guardado correctamente.");
		} else if (data.startsWith("error")) {
			alert("❌ " + data.replace("error:", "").trim());
		} else {
			alert("⚠️ Ocurrió un error desconocido.");
		}
	})
	.catch(error => alert("❌ Error al guardar clima: " + error));
});

document.getElementById("searchValor").addEventListener("input", function () {
	const valor = this.value.trim();
	if (valor === "") {
		document.getElementById("resultadoConteo").textContent = "";
		actualizarTabla();
		return;
	}
	fetch(`/clima/buscar?tipo=estado&valor=${encodeURIComponent(valor)}`)
	.then(res => res.json())
	.then(climas => {
		const tbody = document.getElementById("tablaClimas");
		tbody.innerHTML = "";
		document.getElementById("resultadoConteo").textContent = `Se encontraron ${climas.length} resultado(s).`;

		climas.forEach(clima => {
			const fila = document.createElement("tr");
			fila.innerHTML = `
				<td>${clima.cliId}</td>
				<td>${clima.cliEstado}</td>
				<td>${clima.cliTempMax}</td>
				<td>${clima.cliTempMin}</td>
				<td>${clima.cliRecomendacion}</td>
				<td>${clima.clifecha}</td>
				<td>${clima.estacion?.estNombre ?? 'Sin estación'}</td>
				<td>
					<button class="btn btn-warning btn-sm" onclick="editarClima(${clima.cliId})">Editar</button>
					<button class="btn btn-danger btn-sm" onclick="eliminarClima(${clima.cliId})">Eliminar</button>
				</td>
			`;
			tbody.appendChild(fila);
		});
	});
});

function actualizarTabla() {
	fetch("/clima/buscar?tipo=todos&valor=")
	.then(res => res.json())
	.then(climas => {
		const tbody = document.getElementById("tablaClimas");
		tbody.innerHTML = "";
		climas.forEach(clima => {
			const fila = document.createElement("tr");
			fila.innerHTML = `
				<td>${clima.cliId}</td>
				<td>${clima.cliEstado}</td>
				<td>${clima.cliTempMax}</td>
				<td>${clima.cliTempMin}</td>
				<td>${clima.cliRecomendacion}</td>
				<td>${clima.clifecha}</td>
				<td>${clima.estacion?.estNombre ?? 'Sin estación'}</td>
				<td>
					<button class="btn btn-warning btn-sm" onclick="editarClima(${clima.cliId})">Editar</button>
					<button class="btn btn-danger btn-sm" onclick="eliminarClima(${clima.cliId})">Eliminar</button>
				</td>
			`;
			tbody.appendChild(fila);
		});
	});
}

window.onload = actualizarTabla;
</script>
</div>
</body>
</html>