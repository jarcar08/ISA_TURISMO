<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa de Estaciones - Tren Interactivo</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map {
      height: 600px;
      width: 80%;
      margin: 20px auto;
      border: 2px solid #397d54;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <h2 style="text-align:center;">Mapa Interactivo - Estaciones y Tren</h2>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script th:inline="javascript">
/*<![CDATA[*/
const estaciones = /*[[${estaciones}]]*/ [];

const map = L.map('map').setView([-9.19, -75.015], 6);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const latlngs = [];
const markers = [];
let origenIndex = null;
let destinoIndex = null;
let pasajeroMarker = null;
let destinoMarker = null;
let trenMarker = null;
let embarcado = false;
let desembarcado = false;
let direccion = 1;

const trenIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/64/724/724080.png', iconSize: [40, 40], iconAnchor: [20, 20] });
const pasajeroIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/64/149/149071.png', iconSize: [32, 32], iconAnchor: [16, 16] });

estaciones.forEach((est, i) => {
  const clima = est.clima || {};
  const zonas = est.zonas || [];

  const popupContent = `
    <strong>${est.nombre}</strong><br/>
    <em>Ubicaci√≥n:</em> ${est.ubicacion}<br/>
    <em>Clima:</em> ${clima.estado || 'N/D'}<br/>
    <em>Temp:</em> ${clima.tempMin || '-'}¬∞C - ${clima.tempMax || '-'}¬∞C<br/>
    <em>Recomendaci√≥n:</em> ${clima.recomendacion || 'Ninguna'}<br/>
    <hr/>
    <strong>Zonas Tur√≠sticas:</strong>
    <ul>${zonas.length ? zonas.map(z => `<li>${z.nombre} (${z.dificultad})</li>`).join('') : '<li>No hay zonas</li>'}</ul>
    <hr/>
    <em>Haz clic para elegir esta estaci√≥n</em>
  `;

  const marker = L.marker([est.lat, est.lng]).addTo(map)
    .bindPopup(popupContent)
    .bindTooltip(est.nombre, { permanent: false, direction: 'top' })
    .on('click', () => seleccionarEstacion(i));

  latlngs.push([est.lat, est.lng]);
  markers.push(marker);
});

function calcularTiempoEstaciones(origen, destino, dir) {
  let tiempo = 0;
  let i = origen;
  while (i !== destino) {
    i += dir;
    if (i < 0) i = latlngs.length - 1;
    if (i >= latlngs.length) i = 0;
    tiempo += 5; // segundos por estaci√≥n
  }
  return tiempo;
}

function mostrarInfoVisual(origenIdx, destinoIdx, texto) {
  if (!latlngs[origenIdx] || !latlngs[destinoIdx]) return;
  const distancia = map.distance(latlngs[origenIdx], latlngs[destinoIdx]) / 1000;
  const tiempo = calcularTiempoEstaciones(origenIdx, destinoIdx, direccion);
  L.popup({ closeButton: false })
    .setLatLng([
      (latlngs[origenIdx][0] + latlngs[destinoIdx][0]) / 2,
      (latlngs[origenIdx][1] + latlngs[destinoIdx][1]) / 2
    ])
    .setContent(`üìç ${texto}<br>üìè Distancia: ${distancia.toFixed(2)} km<br>‚è≥ Tiempo estimado: ${tiempo} s`)
    .openOn(map);
}

function seleccionarEstacion(index) {
  if (desembarcado) {
    // Reiniciar si ya termin√≥
    origenIndex = null;
    destinoIndex = null;
    embarcado = false;
    desembarcado = false;
    alert("üîÅ Selecci√≥n reiniciada. Elige estaci√≥n de embarque.");
  }

  if (origenIndex === null) {
    origenIndex = index;
    pasajeroMarker = L.marker(latlngs[origenIndex], { icon: pasajeroIcon }).addTo(map).bindPopup("üßç Embarcar aqu√≠").openPopup();
    alert("‚úÖ Estaci√≥n de embarque seleccionada. Ahora haz clic en tu destino.");
  } else if (destinoIndex === null && index !== origenIndex) {
    destinoIndex = index;
    destinoMarker = L.marker(latlngs[destinoIndex], {
      icon: L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/64/484/484169.png',
        iconSize: [32, 32],
        iconAnchor: [16, 32]
      })
    }).addTo(map).bindPopup(`üéØ Destino: ${estaciones[destinoIndex].nombre}`).openPopup();
    alert("üöÜ Esperando al tren para embarcar...");
  }
}

if (latlngs.length === 0) {
  alert("‚ö†Ô∏è No hay estaciones disponibles.");
} else {
  const ruta = L.polyline(latlngs, { color: 'blue', weight: 4, opacity: 0.7 }).addTo(map);
  map.fitBounds(ruta.getBounds());

  let trenIndex = Math.floor(Math.random() * latlngs.length);
  direccion = Math.random() < 0.5 ? 1 : -1;
  trenMarker = L.marker(latlngs[trenIndex], { icon: trenIcon }).addTo(map).bindPopup("üöÜ Esperando...").openPopup();

  function moverTren() {
    trenMarker.setLatLng(latlngs[trenIndex]);
    trenMarker.setPopupContent(`üöÜ En espera...<br>${direccion === 1 ? "üü¢ Ida" : "üîÑ Vuelta"}`);
    trenMarker.openPopup();

    setTimeout(() => {
      trenIndex += direccion;
      if (trenIndex < 0 || trenIndex >= latlngs.length) {
        direccion *= -1;
        trenIndex += direccion;
      }

      trenMarker.setLatLng(latlngs[trenIndex]);
      trenMarker.setPopupContent(`üöÜ En ruta<br>${direccion === 1 ? "üü¢ Ida" : "üîÑ Vuelta"}`);
      trenMarker.openPopup();

      if (!embarcado && origenIndex !== null && destinoIndex !== null && trenIndex !== origenIndex) {
    	  mostrarInfoVisual(trenIndex, origenIndex, "Esperando embarque");
    	}

      if (!embarcado && trenIndex === origenIndex) {
        embarcado = true;
        map.removeLayer(pasajeroMarker);
        const embarquePopup = L.popup({ closeButton: false, autoClose: false })
        .setLatLng(latlngs[trenIndex])
        .setContent("üöç Pasajero embarcado. En camino al destino.")
        .openOn(map);

      setTimeout(() => map.closePopup(embarquePopup), 3000);

      }

      if (embarcado && trenIndex !== destinoIndex && !desembarcado) {
    	  mostrarInfoVisual(trenIndex, destinoIndex, "Pasajero en ruta hacia destino");
    	}

      if (embarcado && !desembarcado && trenIndex === destinoIndex) {
        desembarcado = true;
        const desembarquePopup = L.popup()
        .setLatLng(latlngs[trenIndex])
        .setContent(`‚úÖ Pasajero desembarcado en: <strong>${estaciones[trenIndex].nombre}</strong>`)
        .openOn(map);

      setTimeout(() => {
        map.closePopup(desembarquePopup);

        if (destinoMarker) {
          map.removeLayer(destinoMarker);
        }

        alert("‚úÖ Pasajero desembarcado. Puedes seleccionar nuevas estaciones.");
      }, 4000);

      }

      setTimeout(moverTren, 5000);
    }, 5000);
  }

  moverTren();
}
/*]]>*/
</script>
</body>
</html>
