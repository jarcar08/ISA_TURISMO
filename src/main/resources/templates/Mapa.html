<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/png" href="/img/favicon.ico">
  <title>Mapa de Estaciones y Tren</title>
  <link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

  <style>
    #map {
      height: 100vh;
      width: 100%;
    }
  </style>
</head>
<body>
	
		<div th:replace="~{fragments/header :: navbar}"></div>
	

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script th:inline="javascript">
  /*<![CDATA[*/
  const estaciones = /*[[${estaciones}]]*/ [];

  const map = L.map('map').setView([-9.19, -75.015], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  const latlngs = [];

  estaciones.forEach(est => {
    const clima = est.clima || {};
    const zonas = est.zonas || [];

    const popupContent = `
      <strong>${est.nombre}</strong><br/>
      <em>Ubicación:</em> ${est.ubicacion}<br/>
      <em>Clima:</em> ${clima.estado || 'N/D'}<br/>
      <em>Temperatura:</em> ${clima.tempMin || '-'}°C - ${clima.tempMax || '-'}°C<br/>
      <em>Recomendación:</em> ${clima.recomendacion || 'Ninguna'}<br/>
      <hr/>
      <strong>Zonas Turísticas:</strong>
      <ul>
        ${zonas.length > 0 ? zonas.map(z => `<li>${z.nombre} (${z.dificultad})</li>`).join('') : '<li>No hay zonas</li>'}
      </ul>
    `;

    L.marker([est.lat, est.lng]).addTo(map)
      .bindPopup(popupContent);

    latlngs.push([est.lat, est.lng]);
  });

  // Verificar si hay estaciones
  if (latlngs.length === 0) {
    alert("⚠️ No hay estaciones disponibles para mostrar.");
  } else {
    // Generar ruta aleatoria
    const shuffled = [...latlngs].sort(() => 0.5 - Math.random()).slice(0, Math.min(5, latlngs.length));

    const polyline = L.polyline(shuffled, {
      color: 'blue',
      weight: 5,
      opacity: 0.7
    }).addTo(map);

    map.fitBounds(polyline.getBounds());

    const trenIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/64/724/724080.png',
      iconSize: [40, 40],
      iconAnchor: [20, 20],
      popupAnchor: [0, -20]
    });

    // Crear y mover el tren
    if (shuffled.length > 0) {
      let trenMarker = L.marker(shuffled[0], { icon: trenIcon }).addTo(map).bindPopup("🚆 Tren en ruta");
      let index = 1;

      function moverTren() {
        if (index < shuffled.length) {
          trenMarker.setLatLng(shuffled[index]);
          index++;
          setTimeout(moverTren, 1500);
        }
      }

      moverTren();
    }
  }
  /*]]>*/
  </script>
</body>
</html>