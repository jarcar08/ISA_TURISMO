<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Gestión de Tarifas</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
</head>

<body>
	
	<div th:replace="~{fragments/header :: navbar}"></div>
	
	<div class="container mt-4">
		<h2 class="mb-4">Lista de Tarifas</h2>

		<!-- Buscador por precio o tipo de pasajero -->
		<div class="mb-3">
			<label for="searchValor" class="form-label">Buscar por precio
				o tipo</label> <input type="text" class="form-control" id="searchValor"
				placeholder="Escribe un precio o tipo...">
		</div>

		<!-- N° de resultados -->
		<div id="resultadoConteo" class="mb-3 text-muted"></div>

		<!-- Botón para agregar nueva tarifa -->
		<button class="btn btn-success mb-3" data-bs-toggle="modal"
			data-bs-target="#tarifaModal" onclick="abrirModal()">Nueva
			Tarifa</button>

		<!-- Tabla de tarifas -->
		<table class="table table-bordered table-striped">
			<thead>
				<tr>
					<th>ID</th>
					<th>Precio Pasaje</th>
					<th>Tipo Pasajero</th>
					<th>Operaciones</th>
				</tr>
			</thead>
			<tbody id="tablaTarifas">
				<!-- Se cargan dinámicamente -->
			</tbody>
		</table>

		<!-- Modal para insertar/editar tarifa -->
		<div class="modal fade" id="tarifaModal" tabindex="-1"
			aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<form id="tarifaForm" th:action="@{/tarifas/guardar}" method="post">
						<div class="modal-header">
							<h5 class="modal-title" id="modalTitle">Nueva Tarifa</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal"
								aria-label="Cerrar"></button>
						</div>
						<div class="modal-body">
							<input type="hidden" id="taId" name="taId">

							<div class="mb-3">
								<label for="taPrecioPasaje" class="form-label"> Precio
									Pasaje <span class="text-danger">*</span>
								</label> <input type="text" class="form-control" id="taPrecioPasaje"
									name="taPrecioPasaje" required>
							</div>

							<div class="mb-3">
								<label for="tipoPasajero" class="form-label"> Tipo
									Pasajero </label> <select class="form-select" id="tipopasajero"
									name="tipopasajero" required>
									<option value="">-- Selecciona un Tipo --</option>
									<option th:each="tp : ${tipopasajero}" th:value="${tp.tpId}"
										th:text="${tp.tpNombre}"></option>
								</select>
							</div>
						</div>
						<div class="modal-footer">
							<button type="submit" class="btn btn-primary">Guardar</button>
							<button type="button" class="btn btn-secondary"
								data-bs-dismiss="modal">Cancelar</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<!-- Scripts de Bootstrap -->
		<script
			src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
        </script>

		<script>
        // Abre modal en modo "nuevo"
        function abrirModal() {
            document.getElementById("modalTitle").innerText = "Nueva Tarifa";
            document.getElementById("taId").value = "";
            document.getElementById("taPrecioPasaje").value = "";
            document.getElementById("tipoPasajero").value = "";
        }

        // Carga datos en modal para editar
        function editarTarifa(id) {
  fetch('/tarifas/editar/' + id)
    .then(res => res.ok ? res.json() : Promise.reject())
    .then(data => {
      document.getElementById("modalTitle").innerText = "Editar Tarifa";

      document.getElementById("taId").value = data.taId;
      document.getElementById("taPrecioPasaje").value = data.taPrecioPasaje;

      // Aquí usamos el mismo id del select:
      const sel = document.getElementById("tipopasajero");
      if (data.tipopasajero && data.tipopasajero.tpId != null) {
        sel.value = data.tipopasajero.tpId;
      } else {
        sel.value = "";
      }

      new bootstrap.Modal(document.getElementById("tarifaModal")).show();
    })
    .catch(() => alert("Error al cargar la tarifa"));
}

        // Eliminar tarifa
        function eliminarTarifa(id) {
            if (!confirm("¿Eliminar esta tarifa?")) return;
            fetch(`/tarifas/eliminar/${id}`, { method: 'DELETE' })
                .then(res => {
                    if (res.ok) {
                        alert("✅ Tarifa eliminada");
                        actualizarTabla();
                    } else {
                        alert("❌ No se pudo eliminar");
                    }
                })
                .catch(() => alert("Error al eliminar"));
        }

        // Submit asíncrono del formulario
        document.getElementById("tarifaForm").addEventListener("submit", e => {
            e.preventDefault();
            const form = e.target;
            const datos = new FormData(form);
            // Quitar taId vacío para POST /crear
            if (!datos.get('taId')) datos.delete('taId');

            fetch(form.getAttribute('action'), {
                method: 'POST',
                body: datos
            })
            .then(res => res.text())
            .then(resp => {
                bootstrap.Modal.getInstance(document.getElementById("tarifaModal")).hide();
                actualizarTabla();
                alert(resp === 'ok'
                    ? '✅ Tarifa guardada'
                    : '⚠️ ' + resp);
            })
            .catch(() => alert("Error al guardar tarifa"));
        });

        // Buscador por ID o tipo
        document.getElementById("searchValor").addEventListener("input", function() {
  		const valor = this.value.trim();
  		if (valor === "") {
    	document.getElementById("resultadoConteo").textContent = "";
    	return actualizarTabla();
  }

  // Si es un entero puro, lo tomo como ID; si no, como tipo de pasajero
  const esEntero = /^\d+$/.test(valor);
  const tipo = esEntero ? 'id' : 'tipo';

  fetch(`/tarifas/buscar?tipo=${tipo}&valor=${encodeURIComponent(valor)}`)
    .then(res => res.json())
    .then(lista => {
      renderTabla(lista);
      document.getElementById("resultadoConteo")
              .textContent = `Se encontraron ${lista.length} tarifa(s).`;
    })
    .catch(err => console.error("Error al buscar:", err));
});

        // Renderiza filas en la tabla
        function renderTabla(lista) {
    		const tbody = document.getElementById("tablaTarifas");
    		tbody.innerHTML = '';
    		lista.forEach(t => {
        		const tipoNombre = t.tipopasajero?.tpNombre || '—';
        		const tr = document.createElement('tr');
        		tr.innerHTML = `
            		<td>${t.taId}</td>
            		<td>${t.taPrecioPasaje}</td>
            		<td>${tipoNombre}</td>
            		<td>
               			<button class="btn btn-warning btn-sm" onclick="editarTarifa(${t.taId})">Editar</button>
               			<button class="btn btn-danger btn-sm" onclick="eliminarTarifa(${t.taId})">Eliminar</button>
            		</td>`;
        		tbody.appendChild(tr);
    		});
        }

        // Carga todas las tarifas al inicio o tras operaciones
        function actualizarTabla() {
            fetch('/tarifas/buscar?tipo=todos&valor=')
                .then(res => res.json())
                .then(renderTabla)
                .catch(() => console.error("Error al cargar tarifas"));
        }

        window.onload = actualizarTabla;
        </script>
	</div>
</body>
</html>
