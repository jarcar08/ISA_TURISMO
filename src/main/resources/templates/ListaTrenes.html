<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/png" href="/img/favicon.ico">
  <title>Lista de Trenes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
        rel="stylesheet">
</head>
<body>

	<div th:replace="~{fragments/header :: navbar}"></div>

  <div class="container mt-4">
    <h2>Lista de Trenes</h2>

    <div class="mb-3">
      <label for="searchValor" class="form-label">
        Buscar por ID o Nombre
      </label>
      <input type="text" id="searchValor" class="form-control"
             placeholder="Escribe un ID o nombre de tren...">
    </div>
    <div id="resultadoConteo" class="mb-3 text-muted"></div>

    <button class="btn btn-success mb-3"
            data-bs-toggle="modal"
            data-bs-target="#trenModal"
            onclick="abrirModal()">
      Nuevo Tren
    </button>

    <table class="table table-striped">
      <thead>
        <tr>
          <th>ID</th><th>Nombre</th><th>Estado</th><th>Operaciones</th>
        </tr>
      </thead>
      <tbody id="tablaTrenes"></tbody>
    </table>
  </div>

  <!-- Modal Tren -->
  <div class="modal fade" id="trenModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="trenForm" th:action="@{/trenes/guardar}" method="post">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Nuevo Tren</h5>
            <button type="button" class="btn-close"
                    data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="trenId" name="trenId">

            <div class="mb-3">
              <label class="form-label">Nombre</label>
              <input type="text" class="form-control" id="trenNombre" name="trenNombre" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Estado</label>
              <select class="form-select" id="trenEstado" name="trenEstado" required>
                <option value="">-- Selecciona Estado --</option>
                <option th:each="e : ${estados}"
                        th:value="${e}"
                        th:text="${e}"></option>
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Guardar</button>
            <button type="button" class="btn btn-secondary"
                    data-bs-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Renderiza lista en la tabla
    function renderTrenes(list) {
      const tbody = document.getElementById("tablaTrenes");
      tbody.innerHTML = "";
      list.forEach(t => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${t.trenId}</td>
          <td>${t.trenNombre}</td>
          <td>${t.trenEstado}</td>
          <td>
            <button class="btn btn-warning btn-sm" onclick="editar(${t.trenId})">Editar</button>
            <button class="btn btn-danger btn-sm" onclick="eliminar(${t.trenId})">Eliminar</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    // Carga todos al inicio o tras operaciones
    function actualizarTabla() {
      fetch("/trenes/buscar?tipo=todos&valor=")
        .then(r => r.json())
        .then(renderTrenes);
    }

    // Búsqueda por input
    document.getElementById("searchValor")
      .addEventListener("input", function() {
        const v = this.value.trim();
        if (!v) {
          document.getElementById("resultadoConteo").textContent = "";
          return actualizarTabla();
        }
        const isNum = /^\d+$/.test(v);
        const tipo = isNum ? 'id' : 'tipo';
        fetch(`/trenes/buscar?tipo=${tipo}&valor=${encodeURIComponent(v)}`)
          .then(r => r.json())
          .then(list => {
            renderTrenes(list);
            document.getElementById("resultadoConteo")
                    .textContent = `Se encontraron ${list.length} tren(es).`;
          });
      });

    // Abre modal en modo Nuevo
    function abrirModal() {
      document.getElementById("modalTitle").innerText = "Nuevo Tren";
      ["trenId","trenNombre","trenEstado"].forEach(id => 
        document.getElementById(id).value = "");
    }

    // Editar
    function editar(id) {
      fetch(`/trenes/editar/${id}`)
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(t => {
          document.getElementById("modalTitle").innerText = "Editar Tren";
          document.getElementById("trenId").value = t.trenId;
          document.getElementById("trenNombre").value = t.trenNombre;
          document.getElementById("trenEstado").value = t.trenEstado;
          new bootstrap.Modal(document.getElementById("trenModal")).show();
        });
    }

    // Eliminar
    function eliminar(id) {
      if (!confirm("¿Eliminar este tren?")) return;
      fetch(`/trenes/eliminar/${id}`, { method:'DELETE' })
        .then(r => { if (r.ok) actualizarTabla(); });
    }

    // Submit AJAX del formulario
    document.getElementById("trenForm").addEventListener("submit", e => {
      e.preventDefault();
      const f = new FormData(e.target);
      if (!f.get("trenId")) f.delete("trenId");
      fetch(e.target.action, { method:'POST', body: f })
        .then(r => r.text())
        .then(resp => {
          bootstrap.Modal.getInstance(document.getElementById("trenModal")).hide();
          actualizarTabla();
          alert(resp==='ok' ? "✅ Guardado" : resp);
        });
    });

    window.onload = actualizarTabla;
  </script>
</body>
</html>
